# ===================================================================
#  通用键位绑定 (Common Keybindings) - v4 (最终版)
#  ~/.config/tmux/conf.d/keys/common.conf
# ===================================================================
#  这些快捷键与键盘布局无关, 在任何设置下都应该生效.
#

# -------------------------------------------------------------------
# 1. 退出与分离 (Exit & Detach)
# -------------------------------------------------------------------
# 毁灭性操作 - 退出整个 Tmux 服务
bind Q confirm-before -p "关闭所有会话 (kill-server)? (y/n)" kill-server

# 毁灭性操作 - 仅关闭当前会话
bind q confirm-before -p "关闭当前会话 '#S' (kill-session)? (y/n)" kill-session

# 非毁灭性操作 - 安全地分离客户端
bind d detach-client # 注意: 这里是小写 d, 更符合 detach 的语义

# -------------------------------------------------------------------
# 2. 会话与窗口管理
# -------------------------------------------------------------------
bind C new-session
bind s choose-session
bind $ command-prompt -I "#S" "rename-session '%%'"

bind & confirm-before -p "关闭当前窗口? (y/n)" kill-window # 使用 & 关闭窗口
bind . command-prompt "rename-window '%%'"

# -------------------------------------------------------------------
# 3. 窗格管理
# -------------------------------------------------------------------
bind x confirm-before -p "关闭当前窗格? (y/n)" kill-pane

# -------------------------------------------------------------------
# 4. 布局与缓冲区
# -------------------------------------------------------------------
bind Space next-layout
bind p paste-buffer
bind b list-buffers

# -------------------------------------------------------------------
# 5. 插件管理 (路径已修正)
# -------------------------------------------------------------------
set -g @tpm_path '~/.config/tmux/plugins' # 定义TPM路径变量
bind I run-shell "#{@tpm_path}/tpm/bin/install_plugins" \; display " installing plugins..."
bind U run-shell "#{@tpm_path}/tpm/bin/update_plugins all" \; display " updating plugins..."
bind R run-shell "#{@tpm_path}/tpm/bin/clean_plugins" \; display " cleaning plugins..."

# -------------------------------------------------------------------
# 6. 开发者工具 (语法已修正)
# -------------------------------------------------------------------
bind C-t command-prompt -p "Broadcast to all panes:" "run-shell 'tmux list-panes -F \"##{pane_id}\" | xargs -I PANE tmux send-keys -t PANE \"%%\" Enter'"
bind e if-shell '[ -n "#{pane_current_path}" ]' 'split-window -h -c "#{pane_current_path}" "$EDITOR ."'
bind g split-window -v "git status; echo; read -p 'Press Enter to close...'"

# -------------------------------------------------------------------
# 7. 帮助与信息
# -------------------------------------------------------------------
bind '?' list-keys
bind C-i display-message "Tmux v#{version} | Host: #{host} | Prefix: #{prefix}"

# -------------------------------------------------------------------
# 8. 性能与调试
# -------------------------------------------------------------------
bind _ set-option status off \; display "状态栏已禁用"
bind + set-option status on \; display "状态栏已启用"
