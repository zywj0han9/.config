#!/usr/bin/env -S tmux set-option -g

### ======================
### Tmux 插件管理器 (TPM)
### ======================

# 设置 TPM 安装路径
set -g @plugin 'tmux-plugins/tpm'
set -g @tpm_install_path '~/.tmux/plugins/tpm'

# TPM 自动安装
if "test ! -d ~/.tmux/plugins/tpm" {
    run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm'
    run '~/.tmux/plugins/tpm/bin/install_plugins'
}

### ======================
### 核心功能插件
### ======================

# 基础最佳实践 (必要插件)
set -g @plugin 'tmux-plugins/tmux-sensible'

# 会话持久化 (保存/恢复)
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-strategy-nvim 'session'     # 支持 Neovim 会话恢复
set -g @resurrect-capture-pane-contents 'on'  # 保存窗格内容
set -g @resurrect-processes 'ssh mysql sqlite3 psql irb pry' # 特殊进程处理

# 自动保存/恢复 (配合 resurrect)
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'               # 启动时自动恢复
set -g @continuum-save-interval '15'         # 每15分钟自动保存

# 模糊查找增强
set -g @plugin 'sainnhe/tmux-fzf'
set -g @fzf-goto-session-key 'C-s'          # 会话搜索 (前缀 + C-s)
set -g @fzf-goto-window-key 'C-w'           # 窗口搜索 (前缀 + C-w)
set -g @fzf-goto-pane-key 'C-p'             # 窗格搜索 (前缀 + C-p)

### ======================
### 生产力增强插件
### ======================

# 窗格导航增强 (跳转到最近窗格)
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @pain-control-pane-jump-key 'C-g'    # 前缀 + C-g

# 通知系统 (长时间任务完成提醒)
set -g @plugin 'tmux-plugins/tmux-notify'
set -g @notify-when-job-exits 'all'         # 所有后台任务通知
set -g @notify-sound 'Glass'                # macOS 声音提示

# 电池状态集成 (状态栏增强)
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @batt_icon_status_charging '↑'       # 充电图标
set -g @batt_icon_status_discharging '↓'    # 放电图标

### ======================
### 主题与外观插件
### ======================

# 主题引擎 (支持动态切换)
set -g @plugin 'jimeh/tmux-themepack'
set -g @themepack 'powerline/block/gray'    # 默认主题

# 状态栏组件库
set -g @plugin 'o0th/tmux-nova'
set -g @nova-nerdfonts true                 # 启用 Nerd Fonts
set -g @nova-segment-keyboard-layout "#{?client_prefix,⌨,}#{@keyboard_layout}"

### ======================
### 键盘布局支持插件
### ======================

# 布局切换增强 (Colemak/QWERTY)
set -g @plugin 'joshmedeski/tmux-keyboard-layout'
set -g @keyboard-layout 'qwerty'            # 默认布局
set -g @keyboard-layout-format '◧ %s'       # 状态栏格式
set -g @keyboard-layout-key 'L'             # 切换快捷键 (前缀 + L)

### ======================
### 插件加载系统
### ======================

# 初始化 TPM (必须放在文件末尾)
run '~/.tmux/plugins/tpm/tpm'

# 插件配置后钩子
run -b 'tmux set-hook -g after-load-plugins "run ~/.tmux/scripts/plugin-postinit.sh"'
